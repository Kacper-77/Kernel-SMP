cmake_minimum_required(VERSION 3.16)
set(CMAKE_SYSTEM_NAME Generic)

# Clang
set(CMAKE_C_COMPILER "clang")
set(CMAKE_ASM_COMPILER "clang")

project(KernelSMP C ASM)

include_directories(${CMAKE_SOURCE_DIR}/common)

# Subdirectories
add_subdirectory(boot)
add_subdirectory(kernel)
add_subdirectory(user)

add_custom_target(initrd ALL
    COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/ramdisk
    COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:init.elf> ${CMAKE_BINARY_DIR}/ramdisk/init.elf
    COMMAND tar -cf ${CMAKE_BINARY_DIR}/initrd.tar --format=ustar -C ${CMAKE_BINARY_DIR}/ramdisk init.elf
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_BINARY_DIR}/initrd.tar ${CMAKE_SOURCE_DIR}/esp/initrd.tar
    DEPENDS init.elf
    COMMENT "Building USTAR initrd.tar..."
)
