cmake_minimum_required(VERSION 3.16)
project(boot C)

set(CMAKE_C_STANDARD 11)

# Flags for Clang
set(CMAKE_C_FLAGS "-target x86_64-unknown-windows \
    -ffreestanding                                \
    -fshort-wchar                                 \
    -mno-red-zone                                 \
    -DEFI_X64                                     \
    -DGNU_EFI_USE_MS_ABI                          \
    -Wall -Wextra")

set(EDK2_PATH "${CMAKE_SOURCE_DIR}/edk2")
include_directories(
    ${EDK2_PATH}/MdePkg/Include
    ${EDK2_PATH}/MdePkg/Include/X64
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)

# Bootloader sources
file(GLOB BOOTLOADER_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/src/*.c")

# Build EFI 
add_executable(BOOTX64.efi ${BOOTLOADER_SOURCES})

# Set location
set_target_properties(BOOTX64.efi PROPERTIES
    PREFIX ""
    SUFFIX ""
    OUTPUT_NAME "BOOTX64.EFI"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/esp/EFI/BOOT"
)

# Linking LLD
set(LD_LLD_PATH "/opt/homebrew/bin/ld.lld")

# Link to EFI
target_link_options(BOOTX64.efi PRIVATE
    -target x86_64-unknown-windows
    -nostdlib
    -Wl,-entry:efi_main
    -Wl,-subsystem:efi_application
    -fuse-ld=lld
)