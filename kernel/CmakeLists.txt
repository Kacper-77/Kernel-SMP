cmake_minimum_required(VERSION 3.16)
project(kernel C ASM_NASM)

set(CMAKE_C_STANDARD 11)

# Linking LLD
set(LD_LLD_PATH "/opt/homebrew/bin/ld.lld")

# NASM Flags (output elf64 format)
set(CMAKE_ASM_NASM_FLAGS "-f elf64")

# Flags
set(CMAKE_C_FLAGS "-target x86_64-unknown-elf -ffreestanding -mcmodel=kernel -mno-red-zone -fno-stack-protector -fno-pic -fno-pie -Wall -Wextra")

include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/cpu)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/smp)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/syscall)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/cpu/apic)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/utils)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/sched)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/arch/x86_64)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/arch/x86_64/drivers)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/arch/x86_64/drivers/ps2)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include/memory)
file(GLOB KERNEL_SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/src/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/cpu/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/cpu/*.asm"
    "${CMAKE_CURRENT_SOURCE_DIR}/smp/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/smp/*.asm"
    "${CMAKE_CURRENT_SOURCE_DIR}/cpu/apic/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/memory/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/sched/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/syscall/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/syscall/*.asm"
    "${CMAKE_CURRENT_SOURCE_DIR}/arch/x86_64/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/arch/x86_64/sched/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/arch/x86_64/drivers/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/arch/x86_64/drivers/ps2/*.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/arch/x86_64/*.asm")

# Add executable file
add_executable(kernel.elf ${KERNEL_SOURCES})

# Exit settings
set_target_properties(kernel.elf PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/esp"
    OUTPUT_NAME "kernel"
    SUFFIX ".elf"
)

# Linker path
set(KERNEL_LINKER_SCRIPT "${CMAKE_CURRENT_SOURCE_DIR}/linker.ld")

# MacOS default libs and paths disabled
set(CMAKE_C_LINK_EXECUTABLE "${LD_LLD_PATH} <OBJECTS> -o <TARGET> -T ${KERNEL_LINKER_SCRIPT} -static -nostdlib")

# Properties
set_target_properties(kernel.elf PROPERTIES 
    LINKER_LANGUAGE C
    LINK_DEPENDS "${KERNEL_LINKER_SCRIPT}"
)
